# job220

### Esg220\_ShkSprdAfns

<details>

<summary>AFNelsonSiegel afns = new AFNelsonSiegel( ... )</summary>

* 생성자 , input 세팅&#x20;
*

    <figure><img src="../../../.gitbook/assets/image (43).png" alt=""><figcaption></figcaption></figure>

</details>

<details>

<summary>irScenarioList.addAll(afns.getAfnsResultList());</summary>

#### `initializeAfnsParas();`&#x20;

파라메타 초기화&#x20;

#### `if(this.inputParas != null) this.initParas = this.inputParas;`

모수 뭐 쓸지 결정. this.inputParas가 null이 아니면 초기모수값 설정.&#x20;

#### `kalmanFiltering();`

초기모수를 기준으로 뭔가를 최소화 하는 과정으로 모수를 추정하는 듯.  최적화된 모수를 설정함. (return 없이 모수세트 값만 지정하고 끝)

* \[참고] [https://angeloyeo.github.io/2021/04/07/Kalman\_filter.html](https://angeloyeo.github.io/2021/04/07/Kalman\_filter.html)

#### `afnsShockGenerating();`

충격수준 적용

* BaseShock
* MeanRShock
* LevelShock
* TwistShock

</details>

<details>

<summary>irShockParam. addAll(afns.getAfnsParamList());</summary>

파라메타 값 저장&#x20;

"LAMBDA" , "THETA\_1" , "THETA\_2" , "THETA\_3" , "KAPPA\_1" , "KAPPA\_2" , "KAPPA\_3", "SIGMA\_11", "SIGMA\_21", "SIGMA\_22", "SIGMA\_31", "SIGMA\_32", "SIGMA\_33", "EPSILON"

</details>

<details>

<summary>irShock. addAll(afns.getAfnsShockList());</summary>

충격수준 산출결과 저장&#x20;

</details>







## 0.  금리커브 단위로 반복&#x20;

```java
for(Map.Entry<String, IrCurve> irCrv : irCurveMap.entrySet())
```

{

## 1. check&#x20;

### 1.1.irCurveSwMap

```java
if(!irCurveSwMap.containsKey(irCrv.getKey())) {
	log.warn("No Ir Curve Data [{}] in Smith-Wilson Map for [{}]"
	, irCrv.getKey()
	, bssd);
	continue;
}	
```

### 1.2. modelMstMap

```java
if(!modelMstMap.containsKey(irCrv.getKey())) {
	log.warn("No Model Attribute of [{}] for [{}] in [{}] Table"
	, irModelNm
	, irCrv.getKey()
	, Process.toPhysicalName(IrParamModel.class.getSimpleName()));
	continue;
}

log.info("AFNS Shock Spread (Cont) for [{}({}, {})]"
	, irCrv.getKey()
	, irCrv.getValue().getIrCurveNm()
	, irCrv.getValue().getCurCd());

```

### 1.3. spot rate에 기준일 테너별 데이터 존재 체크 &#x20;

```java
List<String> tenorList = IrCurveSpotDao.getIrCurveTenorList
( bssd
, irCrv.getKey()
, Math.min(StringUtil.objectToPrimitive(irCurveSwMap.get(irCrv.getKey()).getLlp())
	, 20)) ; // llp까지만

log.info("TenorList in [{}]: ID: [{}], llp: [{}], matCd: {}"
	, jobLog.getJobId()
	, irCrv.getKey()
	, irCurveSwMap.get(irCrv.getKey()).getLlp()
	, tenorList);

if(tenorList.isEmpty()) {
	log.warn("No Spot Rate Data [ID: {}] for [{}]"
		, irCrv.getKey()
		, bssd);
	continue;
}
```

## 2.delete&#x20;

### 2.1. IrParamAfnsCalc

```java
int delNum1 = session.createQuery("delete IrParamAfnsCalc a 
               where baseYymm=:param1 
               and a.irModelNm=:param2 
               and a.irCurveNm=:param3")
               			 .setParameter("param1", bssd) 
               			 .setParameter("param2", irModelNm)
               			 .setParameter("param3", irCrv.getKey())
               			 .executeUpdate();

log.info("[{}] has been Deleted 
               in Job:[{}] [IR_MODEL_ID: {}, IR_CURVE_NM: {}, COUNT: {}]"
               , Process.toPhysicalName(IrParamAfnsCalc.class.getSimpleName())
               , jobLog.getJobId()
               , irModelNm
               , irCrv.getKey()
               , delNum1);

```

### 2.2.IrSprdAfnsCalc

```java
int delNum2 = session.createQuery("delete IrSprdAfnsCalc a 
              where baseYymm=:param1 
              and a.irModelNm=:param2 
              and a.irCurveNm=:param3")
                     .setParameter("param1", bssd) 
                     .setParameter("param2", irModelNm)
                     .setParameter("param3", irCrv.getKey())
                     .executeUpdate(); 		

log.info("[{}] has been Deleted 
                     in Job:[{}] [IR_MODEL_ID: {}, IR_CURVE_NM: {}, COUNT: {}]"
                     , Process.toPhysicalName(IrSprdAfnsCalc.class.getSimpleName())
                     , jobLog.getJobId()
                     , irModelNm
                     , irCrv.getKey()
                     , delNum2);

```

## 3. 필요 데이터 준비 &#x20;

### 3.1.spot rate his (금리내역)

```java
List<IrCurveSpotWeek> weekHisList = IrCurveSpotWeekDao.getIrCurveSpotWeekHis
    ( bssd
    , iRateHisStBaseDate
    , irCrv.getKey()
    , tenorList
    , weekDay
    , false);
List<IrCurveSpotWeek> weekHisBizList = IrCurveSpotWeekDao.getIrCurveSpotWeekHis
    ( bssd
    , iRateHisStBaseDate
    , irCrv.getKey()
    , tenorList
    , weekDay
    , true);
log.info("weekHisList: [{}], [TOTAL: {}, BIZDAY: {}], [from {} to {}, weekDay:{}]"
    , irCrv.getKey()
    , weekHisList.size()
    , weekHisBizList.size()
    , iRateHisStBaseDate.substring(0,6)
    , bssd
    , weekDay);			
```

### 3.2. 충분성 검토&#x20;

```java
if(weekHisList.size() < 1000) {
	log.warn("Weekly SpotRate Data is not Enough [ID: {}, SIZE: {}] for [{}]"
	, irCrv.getKey()
	, weekHisList.size()
	, bssd);
	continue;
}

List<IrCurveSpot> curveHisList= weekHisList.stream()
	     .map(s->s.convertToHis())
	     .collect(toList());
```

### 3.3. 당월 금리 데이터 (모수)

AFNS 모형에서 모수 추정시 제약조건으로 현재 금리커브와 동일한지 확인용. &#x20;

```java
//Any curveBaseList result in same parameters and spreads.
List<IrCurveSpot> curveBaseList = IrCurveSpotDao.getIrCurveSpot
				(bssd, irCrv.getKey(), tenorList);

if(curveBaseList.size()==0) {
	log.warn("No IR Curve Data [IR_CURVE_NM: {}] for [{}]"
	, irCrv.getKey()
	, bssd);
	continue;
}
```

## 4. biz logic&#x20;

```java
Map<String, List<?>> irShockSenario = new TreeMap<String, List<?>>();
irShockSenario = Esg220_ShkSprdAfns.createAfnsShockScenario
  ( FinUtils.toEndOfMonth(bssd)
  , curveHisList
  , curveBaseList
  , tenorList
  , modelMst  // add 
  , dt
  , sigmaInit
  , irCurveSwMap.get(irCrv.getKey()).getLtfr()
  , irCurveSwMap.get(irCrv.getKey()).getLtfrCp() 
  , projectionYear
  , errorTolerance
  , kalmanItrMax
  , confInterval
  , epsilonInit);
```

## 5. save&#x20;

```java
for(Map.Entry<String, List<?>> rslt : irShockSenario.entrySet()) {												
	rslt.getValue().forEach(s -> session.save(s));

session.flush();
session.clear();
}
```

}

## 6.log&#x20;

```java
completeJob("SUCCESS", jobLog);
```

##
